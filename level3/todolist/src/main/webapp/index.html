<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>todolist</title>
</head>
<body>
<form id="create">
    <input type="text" name="task" value="Задание" title="task">
    <input type="text" name="description" value="Описание" title="description">
    <button onclick="create_task()">Создать задание.</button>
</form>
<label>
    <input type="checkbox" checked onclick="show_done=this.checked;get_table()">
    Показывать все задачи
</label>
<div id="table_task"></div>
<button onclick="get_table();">Обновить</button>

<script>
    let table_item = {};
    let show_done = true;
    let head_fields = ["id", "task", "description", "created", "done"]

    function ajax(data, func) {
        fetch("ajax", {
            method: 'post',
            headers: {
                "Content-type": "application/x-www-form-urlencoded; charset=UTF-8"
            },
            body: JSON.stringify(data)
        })
            .then(data => data.json())
            .then(func)
            .catch(err => console.log("ajax - error:" + err))
    }

    let buildHeader = () => {
        let thead = document.createElement('thead');
        let tr = document.createElement('tr');
        for (let el of head_fields) {
            let t = document.createElement('th')
            t.innerText = el
            t.style = 'background: navy; border: 1px solid white;  padding:5px; '
            tr.appendChild(t)
        }
        thead.appendChild(tr)
        return thead
    }

    let checkBox = (checked, id) => {
        let check = document.createElement('input')
        check.setAttribute('type', 'checkbox')
        if(checked) {
            check.setAttribute('checked','')
        }
        // check.setAttribute('disabled', 'true')
        check.onclick = function () {
            ajax({action: 'done', id, done:this.checked}, () => get_table())
        }
        return check;
    }

    let buildBody = (bodyArr) => {
        let tbody = document.createElement('tbody');
        for (let row of bodyArr) {
            if (!show_done && row['done']) {
                continue
            }
            let tr = document.createElement('tr');
            for (let i of head_fields) {
                let t = document.createElement('td')
                if (i === 'done') {
                    t.appendChild(checkBox(row['done'] === true, row['id']))
                } else if (row[i] !== undefined) {
                    t.innerText = row[i]
                    t.style = 'border: 1px solid grey; padding:5px; '
                }
                tr.appendChild(t)
            }
            tbody.appendChild(tr)
        }
        return tbody
    }

    function update_table() {
        let table = document.createElement('table')
        table.classList.add('table')
        table.id = 'table_task'
        table.style = "background: maroon;" +
            " color: white; border: 1px solid grey;" +
            " margin:0; border-spacing:0; text-align: center;"
        table.appendChild(buildHeader())
        table.appendChild(buildBody(table_item.data.sort((a,b) => a.id - b.id)))
        table.appendChild(document.createElement('tfoot'))
        document.getElementById('table_task').replaceWith(table);
    }

    function get_table() {
        ajax({action: "get"}, data => {
            table_item = data;
            update_table();
        });
    }

    get_table();

    function create_task() {
        event.preventDefault();
        let form = document.getElementById("create");
        let data = {
            action: "create",
            task: form.elements.task.value,
            description: form.elements.description.value
        };
        ajax(data, data => {
            if (data.success === true) {
                get_table();
                update_table();
            } else {
                console.log("error create - " + data.error);
            }
        });
    }
</script>
</body>
</html>
